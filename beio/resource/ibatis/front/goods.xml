<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="goods">

	<!-- 搜索记录 -->
	<insert id="insertSearch" parameterType="Object">
		insert into gds_search(id, keyword, creator, createTime) 
			values(#{id}, #{keyword}, #{creator}, #{createTime});
	</insert>
	
	<!-- 查询导航 -->
	<select id="queryNavbars" parameterType="Object" resultType="GdsNavbar">
		SELECT * FROM gds_navbar WHERE enable = '1' AND exist = '1' ORDER BY sort + '' ASC;
	</select>

	<!-- 查询热搜 -->
	<select id="queryHotKeyword" parameterType="Object" resultType="GdsSearch">
		SELECT keyword FROM gds_search GROUP BY keyword ORDER BY COUNT(1) DESC LIMIT 8;
	</select>
	
	<!-- 查询轮播 -->
	<select id="queryBanners" parameterType="Object" resultType="GdsBanner">
		SELECT * FROM gds_banner WHERE enable = '1' AND exist = '1' ORDER BY sort + '' ASC;
	</select>
	
	<!-- 查询分类 -->
	<select id="queryBrands" parameterType="Object" resultType="GdsBrand">
		SELECT * FROM gds_brand WHERE enable = '1' AND exist = '1' ORDER BY sort + '' ASC;
	</select>
	
	<!-- 查询分类 -->
	<select id="queryClassifys" parameterType="Object" resultType="ClassifyVO">
		SELECT * FROM gds_classify WHERE enable = '1' AND exist = '1' 
		<if test="level != null and level != ''">
			AND level = #{level} 
		</if>
		<if test="isShow != null and isShow != ''">
			AND isShow = #{isShow} 
		</if>
		ORDER BY level + '' ASC , pid + '' ASC , sort + '' ASC;
	</select>
	
	<!-- 查询商品 -->
	<select id="queryGoodsByID" parameterType="Object" resultType="GoodsVO">
		SELECT * FROM gds_goods WHERE enable = '1' AND exist = '1' AND id = #{id}
	</select>
	
	<!-- 根据分类查询商品 -->
	<select id="queryGoodsByClassify" parameterType="Object" resultType="GoodsVO">
		SELECT goods.* FROM gds_goods goods
		<if test="id != null and id != ''">
			INNER JOIN
			(SELECT id FROM gds_classify WHERE id = #{id} 
				UNION ALL 
				SELECT id FROM gds_classify WHERE pid = #{id} 
			) classify ON goods.classifyID = classify.id
		</if>
		WHERE goods.enable = '1' AND goods.exist = '1'
		ORDER BY goods.heatUp + '' DESC
		LIMIT #{firstResult}, #{maxResults};
	</select>
	
	<!-- 根据商品查询展示图 -->
	<select id="queryShowsByGoods" parameterType="Object" resultType="GdsImage">
		SELECT * FROM gds_image WHERE enable = '1' AND exist = '1' AND category = '0' AND goodsID = #{id};
	</select>
	
	<!-- 根据商品查询详情图 -->
	<select id="queryDetailsByGoods" parameterType="Object" resultType="GdsImage">
		SELECT * FROM gds_image WHERE enable = '1' AND exist = '1' AND category = '1' AND goodsID = #{id};
	</select>
	
	<!-- 查询分类导航-->
	<select id="queryClassifyNavBar" parameterType="Object" resultType="GdsClassify">
		SELECT * FROM gds_classify WHERE enable = '1' AND exist = '1' 
		<choose>
			<when test="category != null and category != ''">
				AND id = #{category} UNION ALL 
				SELECT * FROM gds_classify WHERE id = (
				SELECT pid FROM gds_classify WHERE id = #{category}) 
			</when>
			<otherwise>
				AND 1=0
			</otherwise>
		</choose>
		ORDER BY level + '' ASC 
	</select>
	
	<!-- 查询分类 -->
	<select id="queryClassifysBySearch" parameterType="Object" resultType="GdsClassify">
		SELECT * FROM gds_classify WHERE enable = '1' AND exist = '1' 
		<choose>
			<when test="category != null and category != ''">
				AND pid = #{category} 
			</when>
			<otherwise>
				AND pid = '0' 
			</otherwise>
		</choose>
		ORDER BY level + '' ASC , pid + '' ASC , sort + '' ASC;
	</select>
	
	<!-- 根据分类查询商品 -->
	<select id="queryGoodsBySearch" parameterType="Object" resultType="GoodsVO">
		SELECT 
		<choose>
			<when test="pageQueryCount == false">
				goods.* 
			</when>
			<otherwise>
				count(1) as pageTotal 
			</otherwise>
		</choose>
		FROM gds_goods goods
		<if test="category != null and category != ''">
			INNER JOIN
			(SELECT id FROM gds_classify WHERE id = #{category} 
				UNION ALL 
				SELECT id FROM gds_classify WHERE pid = #{category} 
			) classify ON goods.classifyID = classify.id
		</if>
		WHERE goods.enable = '1' AND goods.exist = '1'
		<if test="brand != null and brand != ''">
			AND goods.brandID = #{brand} 
		</if>
		<if test="keyword != null and keyword != ''">
			AND goods.name REGEXP #{keyword}
		</if>
		<choose>
			<when test="login">
				<if test="minPrice != null and minPrice != ''">
					AND goods.mPrice <![CDATA[>=]]> #{minPrice}
				</if>
				<if test="maxPrice != null and maxPrice != ''">
					AND goods.mPrice <![CDATA[<=]]> #{maxPrice}
				</if>
			</when>
			<otherwise>
				<if test="minPrice != null and minPrice != ''">
					AND goods.cPrice <![CDATA[>=]]> #{minPrice}
				</if>
				<if test="maxPrice != null and maxPrice != ''">
					AND goods.cPrice <![CDATA[<=]]> #{maxPrice}
				</if>
			</otherwise>
		</choose>
		<choose>
			<when test='order == "1"'>
				<if test="login">
					ORDER BY goods.mPrice + '' DESC
				</if>
				<if test="!login">
					ORDER BY goods.cPrice + '' DESC
				</if>
			</when>
			<when test='order == "2"'>
				ORDER BY goods.createTime + '' ASC
			</when>
			<when test='order == "3"'>
				ORDER BY goods.createTime + '' DESC
			</when>
			<otherwise>
				<if test="login">
					ORDER BY goods.mPrice + '' ASC
				</if>
				<if test="!login">
					ORDER BY goods.cPrice + '' ASC
				</if>
			</otherwise>
		</choose>
		<if test="pageQueryCount == false">
			LIMIT #{firstResult}, #{maxResults};
		</if>
	</select>
	
	<!-- 加入购物车 -->
	<insert id="joinBuycart" parameterType="Object">
		insert into gds_buycart(id, buyerID, goodsID, quantity, creator, createTime, modifier, modifyTime) 
			values(#{id}, #{buyerID}, #{goodsID}, #{quantity}, #{creator}, #{createTime}, #{modifier}, #{modifyTime});
	</insert>
	
	<!-- 更新购物车 -->
	<update id="updtBuycart" parameterType="Object">
		update gds_buycart set quantity = quantity+#{quantity}, modifier = #{modifier}, modifyTime = #{modifyTime} 
			where buyerID = #{buyerID} and goodsID = #{goodsID} and status = '0' and enable = '1' and exist = '1';
	</update>
	
	<!-- 查询购物车数量 -->
	<select id="buycartQuantity" parameterType="Object" resultType="int">
		select ifnull(sum(quantity), 0) as quantity from gds_buycart 
		where buyerID = #{id} and status = '0' and enable = '1' and exist = '1';;
	</select>
	
	<!-- 查询购物车商品 -->
	<select id="queryBuycart" parameterType="Object" resultType="BuycartVO">
		SELECT * FROM gds_buycart WHERE buyerID = #{id} and status = '0' and enable = '1' and exist = '1';
	</select>
	
	<!-- 编辑购物车商品 -->
	<update id="editBuycart" parameterType="Object">
		update gds_buycart 
		<set>
			<if test="quantity != null and quantity != ''">
				quantity = #{quantity},
			</if>
			<if test="exist != null and exist != ''">
				exist = #{exist},
			</if>
			<if test="modifier != null and modifier != ''">
				modifier = #{modifier},
			</if>
			<if test="modifyTime != null and modifyTime != ''">
				modifyTime = #{modifyTime},
			</if>
		</set>
		where id = #{id};
	</update>
	
	<!-- 购物车结算 -->
	<select id="settlement" parameterType="Object" resultType="BuycartVO">
		select * from gds_buycart where id in 
		<foreach collection="cartIDs" index="index" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>
	
	<!-- 商品下单 -->
	<update id="preGoods" parameterType="Object">
		UPDATE gds_goods 
		SET 
		    stock = CASE id
		    <foreach collection="details" index="index" item="item" open="" separator="" close="">
				WHEN #{item.goodsID} THEN CONVERT( stock , SIGNED) - CONVERT( #{item.quantity} , SIGNED)
			</foreach>
		    END, 
		    salds = CASE id
		    <foreach collection="details" index="index" item="item" open="" separator="" close="">
				WHEN #{item.goodsID} THEN CONVERT( salds , SIGNED) + CONVERT( #{item.quantity} , SIGNED)
			</foreach>
		    END
		WHERE
		    id IN 
		<foreach collection="details" index="index" item="item" open="(" separator="," close=")">
			#{item.goodsID}
		</foreach>
	</update>
	
	<!-- 购物车下单 -->
	<update id="preBuycart" parameterType="Object">
		update gds_buycart set status = '1', modifier = #{modifier}, modifyTime = #{modifyTime} 
			where buyerID = #{buyerID} and goodsID in 
		<foreach collection="details" index="index" item="item" open="(" separator="," close=")">
			#{item.goodsID}
		</foreach>
	</update>
	
	<!-- 订单详情下单 -->
	<insert id="preDetails" parameterType="Object">
		insert into gds_details (orderID, goodsID, price, freight, quantity, totalPrice, creator, createTime, modifier, modifyTime) values 
		<foreach collection="details" index="index" item="item" open="" separator="," close="">
			(#{id}, #{item.goodsID}, #{item.price}, #{item.freight}, #{item.quantity}, #{item.totalPrice}, #{creator}, #{createTime}, #{modifier}, #{modifyTime})
		</foreach>
	</insert>
	
	<!-- 购物订单下单 -->
	<insert id="preOrder" parameterType="Object">
		insert into sys_order (orderNo, buyerID, addrName, addrMobile, addrTelephone, addrProvince, addrCity, addrCounty, addrZipcode, addrAddress, 
			payment, receipt, goodsPrice, freight, totalPrice, category, status, creator, createTime, modifier, modifyTime)
		values (#{orderNo}, #{buyerID}, #{addrName}, #{addrMobile}, #{addrTelephone}, #{addrProvince}, #{addrCity}, #{addrCounty}, #{addrZipcode}, #{addrAddress}, 
			#{payment}, #{receipt}, #{goodsPrice}, #{freight}, #{totalPrice}, #{category}, #{status}, #{creator}, #{createTime}, #{modifier}, #{modifyTime});
	</insert>
	
</mapper>