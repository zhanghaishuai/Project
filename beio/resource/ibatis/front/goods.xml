<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="goods">

	<!-- 搜索记录 -->
	<insert id="insertSearch" parameterType="Object">
		insert into gds_search(id, keyword, creator, createTime) 
			values(#{id}, #{keyword}, #{creator}, #{createTime});
	</insert>
	
	<!-- 查询导航 -->
	<select id="queryNavbars" parameterType="Object" resultType="GdsNavbar">
		SELECT * FROM gds_navbar WHERE enable = '1' AND exist = '1' ORDER BY sort + '' ASC;
	</select>

	<!-- 查询热搜 -->
	<select id="queryHotKeyword" parameterType="Object" resultType="GdsSearch">
		SELECT keyword FROM gds_search GROUP BY keyword ORDER BY COUNT(1) DESC LIMIT 8;
	</select>
	
	<!-- 查询轮播 -->
	<select id="queryBanners" parameterType="Object" resultType="GdsBanner">
		SELECT * FROM gds_banner WHERE enable = '1' AND exist = '1' ORDER BY sort + '' ASC;
	</select>
	
	<!-- 查询分类 -->
	<select id="queryBrands" parameterType="Object" resultType="GdsBrand">
		SELECT * FROM gds_brand WHERE enable = '1' AND exist = '1' ORDER BY sort + '' ASC;
	</select>
	
	<!-- 查询分类 -->
	<select id="queryClassifys" parameterType="Object" resultType="ClassifyVO">
		SELECT * FROM gds_classify WHERE enable = '1' AND exist = '1' 
		<if test="level != null and level != ''">
			AND level = #{level} 
		</if>
		<if test="isShow != null and isShow != ''">
			AND isShow = #{isShow} 
		</if>
		ORDER BY level + '' ASC , pid + '' ASC , sort + '' ASC;
	</select>
	
	<!-- 根据分类查询商品 -->
	<select id="queryGoodsByClassify" parameterType="Object" resultType="GoodsVO">
		SELECT goods.* FROM gds_goods goods
		<if test="id != null and id != ''">
			INNER JOIN
			(SELECT id FROM gds_classify WHERE id = #{id} 
				UNION ALL 
				SELECT id FROM gds_classify WHERE pid = #{id} 
			) classify ON goods.classifyID = classify.id
		</if>
		WHERE goods.enable = '1' AND goods.exist = '1'
		ORDER BY goods.heatUp + '' DESC
		LIMIT #{firstResult}, #{maxResults};
	</select>
	
	<!-- 根据商品查询展示图 -->
	<select id="queryShowsByGoods" parameterType="Object" resultType="GdsImage">
		SELECT * FROM gds_image WHERE enable = '1' AND exist = '1' AND category = '0' AND goodsID = #{id};
	</select>
	
	<!-- 根据商品查询详情图 -->
	<select id="queryDetailsByGoods" parameterType="Object" resultType="GdsImage">
		SELECT * FROM gds_image WHERE enable = '1' AND exist = '1' AND category = '1' AND goodsID = #{id};
	</select>
	
	<!-- 查询分类导航-->
	<select id="queryClassifyNavBar" parameterType="Object" resultType="GdsClassify">
		SELECT * FROM gds_classify WHERE enable = '1' AND exist = '1' 
		<choose>
			<when test="category != null and category != ''">
				AND id = #{category}
				UNION ALL 
				SELECT * FROM gds_classify WHERE id = ( 
					SELECT pid FROM gds_classify WHERE id = #{category} 
				) 
			</when>
			<otherwise>
				AND 1=0
			</otherwise>
		</choose>
		ORDER BY level + '' ASC 
	</select>
	
	<!-- 查询分类 -->
	<select id="queryClassifysBySearch" parameterType="Object" resultType="GdsClassify">
		SELECT * FROM gds_classify WHERE enable = '1' AND exist = '1' 
		<choose>
			<when test="category != null and category != ''">
				AND pid = #{category} 
			</when>
			<otherwise>
				AND pid = '0' 
			</otherwise>
		</choose>
		ORDER BY level + '' ASC , pid + '' ASC , sort + '' ASC;
	</select>
	
	<!-- 根据分类查询商品 -->
	<select id="queryGoodsBySearch" parameterType="Object" resultType="GoodsVO">
		SELECT 
		<choose>
			<when test="pageQueryCount == false">
				goods.* 
			</when>
			<otherwise>
				count(1) as pageTotal 
			</otherwise>
		</choose>
		FROM gds_goods goods
		<if test="category != null and category != ''">
			INNER JOIN
			(SELECT id FROM gds_classify WHERE id = #{category} 
				UNION ALL 
				SELECT id FROM gds_classify WHERE pid = #{category} 
			) classify ON goods.classifyID = classify.id
		</if>
		WHERE goods.enable = '1' AND goods.exist = '1'
		<if test="brand != null and brand != ''">
			AND goods.brandID = #{brand} 
		</if>
		<if test="keyword != null and keyword != ''">
			AND goods.name REGEXP #{keyword}
		</if>
		<choose>
			<when test="login">
				<if test="minPrice != null and minPrice != ''">
					AND goods.mPrice <![CDATA[>=]]> #{minPrice}
				</if>
				<if test="maxPrice != null and maxPrice != ''">
					AND goods.mPrice <![CDATA[<=]]> #{maxPrice}
				</if>
			</when>
			<otherwise>
				<if test="minPrice != null and minPrice != ''">
					AND goods.cPrice <![CDATA[>=]]> #{minPrice}
				</if>
				<if test="maxPrice != null and maxPrice != ''">
					AND goods.cPrice <![CDATA[<=]]> #{maxPrice}
				</if>
			</otherwise>
		</choose>
		<choose>
			<when test='order == "1"'>
				<if test="login">
					ORDER BY goods.mPrice + '' DESC
				</if>
				<if test="!login">
					ORDER BY goods.cPrice + '' DESC
				</if>
			</when>
			<when test='order == "2"'>
				ORDER BY goods.createTime + '' ASC
			</when>
			<when test='order == "3"'>
				ORDER BY goods.createTime + '' DESC
			</when>
			<otherwise>
				<if test="login">
					ORDER BY goods.mPrice + '' ASC
				</if>
				<if test="!login">
					ORDER BY goods.cPrice + '' ASC
				</if>
			</otherwise>
		</choose>
		<if test="pageQueryCount == false">
			LIMIT #{firstResult}, #{maxResults};
		</if>
	</select>
	
</mapper>